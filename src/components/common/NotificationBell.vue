<template>
    <a-dropdown placement="bottomRight" trigger="click">
        <template #default>
            <a-button shape="circle" type="text"
                style="width: 40px; height: 27px; font-size: 20px; display: flex; justify-content: center;">
                <a-badge :count="unreadCount" size="small" :color="mainColor">
                    <BellOutlined style="font-size: 20px; cursor: pointer" />
                </a-badge>
            </a-button>
        </template>

        <template #overlay>
            <div class="dropdown-box">
                <a-list :data-source="notifications.slice(0, 5)" :locale="{ emptyText: 'Không có thông báo' }"
                    item-layout="horizontal" class="notification-list">
                    <template #renderItem="{ item }">
                        <a-list-item class="notification-item" :class="{ unread: !item.is_read }"
                            @click="handleClick(item)">
                            <a-list-item-meta :title="item.title">
                                <template #avatar>
                                    <a-avatar :src="getAvatar(item)" shape="circle" class="avatar-center" />
                                </template>
                                <template #description>
                                    <div class="message">{{ item.message }}</div>
                                    <div class="time">{{ formatDateTime(item.created_at) }}</div>
                                </template>
                            </a-list-item-meta>
                        </a-list-item>
                    </template>
                </a-list>

                <div class="see-all" @click="handleSeeAll">
                    Xem tất cả thông báo
                </div>
            </div>
        </template>
    </a-dropdown>

    <!-- 🔸 Modal động cho FORM (tự chọn component theo form_code) -->
    <component v-if="showDetail && selectedFormInstance" :is="detailComponent" :visible="showDetail"
        :form-instance="selectedFormInstance" @close="showDetail = false" @updated="onDetailUpdated" />

    <!-- 🔸 Modal tin tức -->
    <NewsDetailModal :visible="showNewsModal" :news="selectedNews" @update:visible="showNewsModal = $event" />
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount, computed } from 'vue'
import { BellOutlined } from '@ant-design/icons-vue'
import { notification } from 'ant-design-vue'
import { useAuthStore } from '@/stores/auth'

import notificationService from '@/services/notification_service/notificationService'
import { formInstanceService } from '@/services/form_service/formInstanceService'
import { newsService } from '@/services/news_service/newsService'
import { formatDateTime } from '@/utils/formatDate'

/* Components chi tiết cho từng loại form */
import FormInstanceDetail from '@/pages/forms/leaveForm/FormInstanceDetail.vue'                // GateEntry
import FormVehicleDispatchDetail from '@/pages/forms/vehicleDispatchForm/FormVehicleDispatchDetail.vue' // VehicleDispatch
// Nếu có thêm form khác, import tương tự:
// import LeaveFormDetail from '@/pages/forms/leaveForm/LeaveFormDetail.vue'

const mainColor = '#c06252'
const auth = useAuthStore()

const notifications = ref([])
const unreadCount = ref(0)

/* Modal động cho forms */
const showDetail = ref(false)
const selectedFormInstance = ref(null)
const selectedFormCode = ref('')

/* Map form_code → component */
const detailMap = {
    GateEntry: FormInstanceDetail,
    VehicleDispatch: FormVehicleDispatchDetail,
    // LeaveForm: LeaveFormDetail,
}
const detailComponent = computed(() => detailMap[selectedFormCode.value] || FormInstanceDetail)

/* Modal tin tức */
const selectedNews = ref(null)
const showNewsModal = ref(false)

/* Fetch notifications */
const fetchNotifications = async () => {
    try {
        const res = await notificationService.getAll()
        notifications.value = res.data || []
        unreadCount.value = notifications.value.filter(n => !n.is_read).length
    } catch (error) {
        console.error('Lỗi khi load thông báo:', error)
    }
}

/* Avatar theo module + form_code */
const getAvatar = (item) => {
    if (item.module === 'forms') {
        switch (item.data?.form_code) {
            case 'GateEntry':
                return 'https://cdn-icons-png.flaticon.com/512/32/32205.png'
            case 'VehicleDispatch':
                return 'https://cdn-icons-png.flaticon.com/512/44/44266.png'
            case 'LeaveForm':
                return 'https://cdn-icons-png.flaticon.com/512/4221/4221830.png'
            default:
                return 'https://cdn-icons-png.flaticon.com/512/32/32205.png'
        }
    }
    if (item.module === 'news') {
        return 'https://png.pngtree.com/png-vector/20190725/ourlarge/pngtree-vector-newspaper-icon-png-image_1577280.jpg'
    }
    if (item.module === 'user') {
        return 'https://cdn-icons-png.flaticon.com/512/847/847969.png'
    }
    return item.avatar || 'https://cdn-icons-png.flaticon.com/512/747/747376.png'
}

/* Realtime via Echo */
onMounted(() => {
    fetchNotifications()
    window.Echo.leave('notifications') // clear bind cũ
    window.Echo.channel('notifications')
        .listen('.RealtimeNotificationSent', (e) => {
            if (e.notification.user_id !== auth.user.id) return
            notification.info({
                message: `🔔 ${e.notification.title}`,
                description: e.notification.message,
            })
            fetchNotifications()
        })
})

onBeforeUnmount(() => {
    window.Echo.leave('notifications')
})

/* Click 1 notification */
const handleClick = async (item) => {
    try {
        if (!item.is_read) {
            await notificationService.markAsRead(item.id)
            item.is_read = true
            unreadCount.value = notifications.value.filter(n => !n.is_read).length
        }

        if (item.module === 'forms') {
            // lấy instance rồi chọn component theo form_code
            const formCode = item.data?.form_code
            const res = await formInstanceService.getById(item.reference_id)

            selectedFormInstance.value = res.data
            selectedFormCode.value = formCode || res.data?.form?.code || ''
            showDetail.value = true
            return
        }

        if (item.module === 'news') {
            const res = await newsService.getById(item.reference_id)
            selectedNews.value = res.data.data
            showNewsModal.value = true
            return
        }

        window.location.href = item.link || '/'
    } catch (err) {
        notification.error({
            message: 'Lỗi',
            description: 'Không tải được nội dung. Vui lòng thử lại.'
        })
    }
}

const handleSeeAll = () => {
    window.location.href = '/notifications'
}

function onDetailUpdated() {
    // nếu cần: refresh list sau khi duyệt/từ chối trong modal
    fetchNotifications()
}
</script>

<style scoped>
.notification-item.unread {
    background-color: #fff7f0;
    font-weight: 500;
}

.notification-item.unread:hover {
    background-color: #ffeede;
}

.message {
    font-size: 13px;
    color: #555;
    margin-bottom: 4px;
}

.time {
    font-size: 12px;
    color: #999;
}

.dropdown-box {
    width: 320px;
    max-height: 460px;
    background: #fff;
    border: 1px solid #f0f0f0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, .15);
    border-radius: 8px;
    padding: 10px;
}

.notification-list {
    max-height: 380px;
    overflow-y: auto;
}

.notification-item:hover {
    background-color: #fafafa;
    cursor: pointer;
}

:deep(.ant-list-item-meta-title) {
    font-weight: 600;
    color: #c06252;
    margin-bottom: 4px;
    font-size: 14px;
}

:deep(.ant-list-item-meta-description) {
    font-size: 12px;
    color: #999;
}

.see-all {
    text-align: center;
    padding: 10px;
    border-top: 1px solid #eee;
    font-weight: 500;
    color: #c06252;
    cursor: pointer;
}

.see-all:hover {
    background-color: #f5f5f5;
}
</style>
